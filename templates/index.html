<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å…¨èƒ½å½±é™¢ Pro</title>
    <style>
        /* === 1. é«˜çº§åŠ¨æ€èƒŒæ™¯ === */
        body { 
            margin: 0; padding: 0; 
            color: white; 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
            min-height: 100vh; 
            display: flex; flex-direction: column; align-items: center; 
            background: linear-gradient(-45deg, #0f0c29, #302b63, #24243e, #141e30);
            background-size: 400% 400%;
            animation: gradientBG 15s ease infinite;
        }
        @keyframes gradientBG {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        .glass-panel {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
        }

        .search-container { margin-top: 15vh; text-align: center; width: 90%; max-width: 600px; z-index: 2; }
        
        h1 { 
            font-size: 3rem; margin-bottom: 30px; 
            background: linear-gradient(to right, #ff3b30, #ff9f0a, #ff3b30); 
            background-size: 200% auto;
            -webkit-background-clip: text; -webkit-text-fill-color: transparent; 
            letter-spacing: 2px; 
            animation: shine 3s linear infinite;
        }
        @keyframes shine { to { background-position: 200% center; } }
        
        /* === 3. æœç´¢æ¡†å‡çº§ (ä¿®å¤äº†ä¸‹æ‹‰æ¡†ä¸å¯è§çš„é—®é¢˜) === */
        .search-group { 
            display: flex; 
            border-radius: 50px; 
            padding: 5px; 
            height: 55px; 
            align-items: center; 
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .search-group:focus-within {
            transform: scale(1.02);
            box-shadow: 0 0 25px rgba(255, 59, 48, 0.3);
            border-color: rgba(255, 59, 48, 0.5);
        }
        
        /* ã€å…³é”®ä¿®å¤ã€‘æ¢å¤äº†é»˜è®¤å¤–è§‚ï¼Œç¡®ä¿ç®­å¤´å¯è§ï¼Œå¹¶å¢åŠ äº†æ–‡å­—é¢œè‰² */
        select { 
            background: #1a1a1a; 
            color: #ff9f0a; 
            border: none; 
            padding: 0 15px; 
            font-size: 15px; 
            outline: none; 
            height: 100%; 
            border-right: 1px solid rgba(255,255,255,0.2); 
            font-weight: bold; 
            border-radius: 40px 0 0 40px;
            cursor: pointer;
        }

        /* ã€UIä¿®å¤ã€‘å¼ºåˆ¶ä¸‹æ‹‰é€‰é¡¹ä½¿ç”¨æ·±è‰²èƒŒæ™¯ï¼Œé˜²æ­¢ç™½è‰²å¼¹çª—çªå…€ */
        select option {
            background-color: #1a1a1a;
            color: #ffffff;
            padding: 10px;
        }
        
        input { flex: 1; padding: 0 15px; border: none; background: transparent; color: white; font-size: 16px; outline: none; height: 100%; }
        ::placeholder { color: rgba(255,255,255,0.4); }

        button { 
            padding: 0 25px; height: 45px; border-radius: 40px; border: none; 
            background: linear-gradient(90deg, #ff3b30, #ff6b6b); 
            color: white; font-weight: bold; font-size: 16px; 
            cursor: pointer; box-shadow: 0 4px 15px rgba(255, 59, 48, 0.4);
            transition: all 0.3s ease;
        }
        button:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(255, 59, 48, 0.6); }

        .history-section { width: 92%; margin-top: 50px; z-index: 2; }
        .section-header { display: flex; justify-content: space-between; padding: 0 10px 10px; border-bottom: 1px solid rgba(255,255,255,0.1); margin-bottom: 20px; font-size: 15px; color: rgba(255,255,255,0.6); }
        .clear-btn { cursor: pointer; transition: color 0.3s; }
        .clear-btn:hover { color: #ff3b30; }
        
        .history-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(110px, 1fr)); gap: 15px; }

        .history-card { 
            border-radius: 12px; overflow: hidden; text-decoration: none; position: relative; 
            transition: transform 0.3s ease;
        }
        .history-card:hover { transform: translateY(-5px); }
        .card-img-wrapper { width: 100%; padding-top: 140%; position: relative; background: #000; }
        .card-img { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; opacity: 0.9; transition: opacity 0.3s; }
        .history-card:hover .card-img { opacity: 1; }
        .card-info { padding: 10px; background: rgba(0,0,0,0.4); backdrop-filter: blur(5px); }
        .movie-title { font-size: 13px; color: #eee; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: block; font-weight: 500; }
        .ep-info { font-size: 11px; color: #aaa; margin-top: 4px; }
        .source-tag { position: absolute; top: 6px; right: 6px; background: rgba(255, 159, 10, 0.9); color: #000; font-size: 10px; padding: 2px 6px; border-radius: 4px; font-weight: bold; box-shadow: 0 2px 5px rgba(0,0,0,0.3); }
    </style>
</head>
<body>
    <div class="search-container">
        <h1>MY FLIX PRO</h1>
        <form action="/search" method="POST" class="search-group glass-panel" id="searchForm">
            <select name="source_api" id="sourceSelect">
                {% for source in sources %}
                <option value="{{ source.api }}">{{ source.name }}</option>
                {% endfor %}
            </select>
            <input type="text" name="keyword" placeholder="æ¢ç´¢ç”µå½±ã€å‰§é›†..." required autocomplete="off">
            <button type="submit">æœç´¢</button>
        </form>
    </div>

    <div class="history-section glass-panel" style="padding: 20px; border-radius: 20px;" id="historySection">
        <div class="section-header">
            <span>ğŸ•˜ ç»§ç»­è§‚çœ‹</span>
            <span class="clear-btn" onclick="clearHistory()">æ¸…ç©ºè®°å½•</span>
        </div>
        <div class="history-grid" id="historyGrid"></div>
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            var selectBox = document.getElementById('sourceSelect');
            var savedSource = localStorage.getItem('user_selected_source');
            if (savedSource) {
                // æ£€æŸ¥å·²ä¿å­˜çš„æºæ˜¯å¦å­˜åœ¨äºå½“å‰åˆ—è¡¨ä¸­
                var exists = false;
                for(var i=0; i < selectBox.options.length; i++){
                    if(selectBox.options[i].value === savedSource){ 
                        selectBox.value = savedSource; 
                        exists = true;
                        break; 
                    }
                }
            }
            selectBox.addEventListener('change', function() { localStorage.setItem('user_selected_source', this.value); });
            document.getElementById('searchForm').addEventListener('submit', function() { localStorage.setItem('user_selected_source', selectBox.value); });
            renderHistory();
        });

        function renderHistory() {
            var grid = document.getElementById('historyGrid');
            var historyData = localStorage.getItem('history_list');
            if (!historyData || JSON.parse(historyData).length === 0) {
                document.getElementById('historySection').style.display = 'none'; return;
            }
            document.getElementById('historySection').style.display = 'block';
            grid.innerHTML = '';
            JSON.parse(historyData).forEach(function(item) {
                var apiUrl = item.api || "{{ sources[0].api if sources else '' }}";
                var html = `<a href="/play?id=${item.id}&ep_index=${item.ep_index}&api=${encodeURIComponent(apiUrl)}" class="history-card glass-panel" style="border:none">
                    <div class="card-img-wrapper"><img src="${item.pic}" class="card-img" onerror="this.style.display='none'"><div class="source-tag">ç»­æ’­</div></div>
                    <div class="card-info"><span class="movie-title">${item.title}</span><div class="ep-info">${item.ep_name}</div></div>
                </a>`;
                grid.insertAdjacentHTML('beforeend', html);
            });
        }
        function clearHistory() { localStorage.removeItem('history_list'); renderHistory(); }
    </script>
</body>
</html>