<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ­£åœ¨æ’­æ”¾ - {{ video.title }}</title>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@1.4.0/dist/hls.min.js"></script>
    <style>
        body { margin: 0; background: #000; color: #e0e0e0; font-family: -apple-system, sans-serif; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        .navbar { height: 50px; padding: 0 20px; background: rgba(20, 20, 20, 0.8); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; z-index: 10; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .logo { font-weight: 900; background: linear-gradient(45deg, #ff3b30, #ff9f0a); -webkit-background-clip: text; -webkit-text-fill-color: transparent; text-decoration: none; font-style: italic;}
        .back-link { color: #aaa; text-decoration: none; font-size: 14px; padding: 5px 10px; border-radius: 15px; transition: background 0.3s; }
        .back-link:hover { background: rgba(255,255,255,0.1); color: white; }
        .main-container { display: flex; flex: 1; flex-direction: column; overflow: hidden; position: relative; }
        @media (min-width: 800px) { .main-container { flex-direction: row; } }
        .player-section { flex-shrink: 0; width: 100%; background: #000; position: relative; display: flex; flex-direction: column; }
        @media (min-width: 800px) { .player-section { flex: 3; height: 100%; justify-content: center; } }
        .video-ratio-box { width: 100%; padding-top: 56.25%; position: relative; background: #000; }
        @media (min-width: 800px) { .video-ratio-box { padding-top: 0; height: 100%; } }
        .video-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; overflow: hidden; }
        video, iframe { width: 100%; height: 100%; border: none; outline: none; object-fit: contain; }
        #gestureFeedback { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.6); backdrop-filter: blur(5px); padding: 15px 25px; border-radius: 10px; color: white; font-size: 16px; font-weight: bold; display: none; pointer-events: none; z-index: 20; text-align: center; border: 1px solid rgba(255,255,255,0.1); }
        #gestureFeedback .icon { font-size: 24px; display: block; margin-bottom: 5px; }
        .control-bar { height: 40px; background: #111; display: flex; align-items: center; justify-content: space-between; padding: 0 15px; border-bottom: 1px solid #222; }
        .control-btn { background: #222; color: #ccc; border: none; padding: 5px 15px; border-radius: 4px; font-size: 13px; cursor: pointer; text-decoration: none; display: flex; align-items: center; }
        .control-btn:hover { background: #333; color: white; }
        .control-btn.disabled { opacity: 0.3; pointer-events: none; }
        .ep-info-text { font-size: 12px; color: #666; }
        .sidebar { flex: 1; background: #111; display: flex; flex-direction: column; overflow: hidden; }
        @media (min-width: 800px) { .sidebar { border-left: 1px solid rgba(255,255,255,0.1); max-width: 350px; background: rgba(20, 20, 20, 0.95); } }
        .info-box { padding: 20px; border-bottom: 1px solid #222; }
        .title { font-size: 18px; color: white; margin-bottom: 10px; font-weight: bold; text-shadow: 0 2px 4px rgba(0,0,0,0.5); }
        .desc { font-size: 13px; color: #888; line-height: 1.5; max-height: 60px; overflow-y: auto; }
        .episodes-box { flex: 1; padding: 15px; overflow-y: auto; }
        .ep-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(60px, 1fr)); gap: 10px; }
        .ep-btn { display: flex; align-items: center; justify-content: center; height: 36px; background: rgba(255,255,255,0.05); color: #bbb; text-decoration: none; border-radius: 6px; font-size: 13px; transition: all 0.2s; border: 1px solid transparent; }
        .ep-btn:hover { background: rgba(255,255,255,0.1); color: white; }
        .ep-btn.active { background: linear-gradient(135deg, #ff3b30, #ff9f0a); color: white; font-weight: bold; border: none; box-shadow: 0 4px 10px rgba(255, 59, 48, 0.3); }
        .toast { position: absolute; top: 10%; left: 50%; transform: translateX(-50%); background: rgba(16, 185, 129, 0.9); color: white; padding: 8px 20px; border-radius: 30px; font-size: 13px; display: none; z-index: 99; pointer-events: none; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
    </style>
</head>
<body>
    <div class="navbar">
        <a href="/" class="logo">MY FLIX PRO</a>
        <a href="/" class="back-link">â† è¿”å›é¦–é¡µ</a>
    </div>

    <div class="main-container">
        <div class="player-section">
            <div id="resumeToast" class="toast">ğŸš€ å·²ä¸ºæ‚¨æ¢å¤æ’­æ”¾è¿›åº¦</div>
            <div id="gestureFeedback"><span class="icon">ğŸ”Š</span><span class="text">50%</span></div>
            <div class="video-ratio-box"><div class="video-container" id="playerContainer"></div></div>
            <div class="control-bar">
                {% set prev_index = current_index - 1 %}
                {% if prev_index >= 0 %}
                <a href="/play?id={{ video.id }}&ep_index={{ prev_index }}&api={{ current_api }}" class="control-btn">â® ä¸Šä¸€é›†</a>
                {% else %}<span class="control-btn disabled">â® ä¸Šä¸€é›†</span>{% endif %}
                <span class="ep-info-text">æ­£åœ¨æ’­æ”¾: {{ current_ep.name }}</span>
                {% set next_index = current_index + 1 %}
                {% if next_index < video.episodes|length %}
                <a href="/play?id={{ video.id }}&ep_index={{ next_index }}&api={{ current_api }}" class="control-btn">ä¸‹ä¸€é›† â­</a>
                {% else %}<span class="control-btn disabled">ä¸‹ä¸€é›† â­</span>{% endif %}
            </div>
        </div>
        <div class="sidebar">
            <div class="info-box"><div class="title">{{ video.title }}</div><div class="desc">{{ video.desc }}</div></div>
            <div class="episodes-box">
                <div style="margin-bottom:12px;color:#888;font-size:12px;display:flex;justify-content:space-between;"><span>é€‰é›†åˆ—è¡¨</span><span>å…± {{ video.episodes|length }} é›†</span></div>
                <div class="ep-grid">
                    {% for ep in video.episodes %}
                    <a href="/play?id={{ video.id }}&ep_index={{ ep.index }}&api={{ current_api }}" class="ep-btn {% if ep.index == current_index %}active{% endif %}">{{ ep.name }}</a>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
    
    <script>
        var container = document.getElementById('playerContainer');
        var videoSrc = "{{ current_ep.url }}"; 
        var vodId = "{{ video.id }}";
        var epIndex = "{{ current_index }}";
        var currentApi = "{{ current_api }}";
        var storageKey = "progress_" + vodId + "_" + epIndex;
        var videoElement = null;

        function initPlayer() {
            container.innerHTML = '';
            if (videoSrc.indexOf('.m3u8') === -1 && videoSrc.indexOf('.mp4') === -1) {
                var iframe = document.createElement('iframe');
                iframe.src = videoSrc; iframe.allow = "autoplay; fullscreen"; iframe.frameBorder = "0";
                container.appendChild(iframe); saveHistoryToLocal(); return;
            }
            var video = document.createElement('video');
            video.id = 'videoPlayer'; video.controls = true; video.autoplay = true;
            video.setAttribute('playsinline', ''); video.setAttribute('webkit-playsinline', '');
            container.appendChild(video); videoElement = video;
            if (videoSrc.indexOf('.m3u8') > -1) { setupHls(video); } else { video.src = videoSrc; setupNative(video); }
            initGestures(container, video);
        }

        function setupHls(video) {
            if (Hls.isSupported()) { var hls = new Hls(); hls.loadSource(videoSrc); hls.attachMedia(video); hls.on(Hls.Events.MANIFEST_PARSED, function() { loadProgress(video); }); } 
            else if (video.canPlayType('application/vnd.apple.mpegurl')) { video.src = videoSrc; video.addEventListener('loadedmetadata', function() { loadProgress(video); }); }
            bindEvents(video);
        }
        function setupNative(video) { video.addEventListener('loadedmetadata', function() { loadProgress(video); }); bindEvents(video); }
        function bindEvents(video) { video.addEventListener('timeupdate', function() { if (video.currentTime > 0) localStorage.setItem(storageKey, video.currentTime); }); video.addEventListener('play', saveHistoryToLocal); }
        function loadProgress(video) {
            var lastTime = localStorage.getItem(storageKey);
            if (lastTime && parseFloat(lastTime) > 5) { video.currentTime = parseFloat(lastTime); var toast = document.getElementById('resumeToast'); toast.style.display = 'block'; setTimeout(() => { toast.style.display = 'none'; }, 3000); }
            video.play().catch(e => {});
        }
        function saveHistoryToLocal() {
            var historyKey = "history_list"; var history = JSON.parse(localStorage.getItem(historyKey) || "[]");
            history = history.filter(item => item.id !== vodId);
            history.unshift({ id: vodId, title: "{{ video.title }}", ep_name: "{{ current_ep.name }}", ep_index: epIndex, pic: "{{ video.pic }}", api: currentApi, time: new Date().toLocaleDateString() });
            if (history.length > 20) history.pop(); localStorage.setItem(historyKey, JSON.stringify(history));
        }
        function initGestures(touchArea, video) {
            let startX, startY; let initialVolume; let isTouching = false; let touchType = ''; let currentBrightness = 1.0;
            touchArea.addEventListener('touchstart', (e) => { startX = e.touches[0].clientX; startY = e.touches[0].clientY; initialVolume = video.volume; isTouching = true; touchType = ''; }, {passive: true});
            touchArea.addEventListener('touchmove', (e) => {
                if (!isTouching) return;
                let deltaY = startY - e.touches[0].clientY; let deltaX = e.touches[0].clientX - startX;
                if (Math.abs(deltaX) > Math.abs(deltaY)) return;
                let screenWidth = window.innerWidth;
                if (!touchType) { if (startX < screenWidth / 2) touchType = 'brightness'; else touchType = 'volume'; }
                let percentChange = deltaY / 200;
                if (touchType === 'volume') { let newVol = initialVolume + percentChange; if (newVol > 1) newVol = 1; if (newVol < 0) newVol = 0; video.volume = newVol; showFeedback('ğŸ”Š', Math.round(newVol * 100) + '%'); } 
                else if (touchType === 'brightness') { let newBright = currentBrightness + percentChange; if (newBright > 2) newBright = 2; if (newBright < 0.1) newBright = 0.1; currentBrightness = newBright; video.style.filter = `brightness(${newBright})`; showFeedback('â˜€', Math.round(newBright * 100) + '%'); }
            }, {passive: false});
            touchArea.addEventListener('touchend', () => { isTouching = false; hideFeedback(); });
        }
        var feedbackTimer;
        function showFeedback(icon, text) { var box = document.getElementById('gestureFeedback'); box.innerHTML = `<span class="icon">${icon}</span><span class="text">${text}</span>`; box.style.display = 'block'; clearTimeout(feedbackTimer); }
        function hideFeedback() { feedbackTimer = setTimeout(() => { document.getElementById('gestureFeedback').style.display = 'none'; }, 500); }
        
        initPlayer();

        // === éšå½¢ç»Ÿè®¡ä»£ç  (æ–°å¢) ===
        // åœ¨åå°é»˜é»˜å‘é€å¿ƒè·³ï¼Œè®°å½•è¯¥ç”¨æˆ·æ­£åœ¨è§‚çœ‹è¯¥è§†é¢‘çš„æ—¶é•¿
        setInterval(function() {
            try {
                var data = new URLSearchParams();
                data.append('page', 'watch:' + vodId); // è®°å½•æ­£åœ¨è§‚çœ‹çš„ID
                navigator.sendBeacon('/api/heartbeat', data);
            } catch(e){}
        }, 30000); // 30ç§’ä¸€æ¬¡
    </script>
</body>
</html>