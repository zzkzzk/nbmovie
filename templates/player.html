<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ­£åœ¨æ’­æ”¾ - {{ video.title }}</title>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@1.4.0/dist/hls.min.js"></script>
    <style>
        /* === 1. åŸºç¡€å¸ƒå±€ä¸æ¯›ç»ç’ƒ === */
        body { margin: 0; background: #000; color: #e0e0e0; font-family: -apple-system, sans-serif; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        
        .navbar { 
            height: 50px; padding: 0 20px; 
            background: rgba(20, 20, 20, 0.8); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
            display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; z-index: 10;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .logo { font-weight: 900; background: linear-gradient(45deg, #ff3b30, #ff9f0a); -webkit-background-clip: text; -webkit-text-fill-color: transparent; text-decoration: none; font-style: italic;}
        .back-link { color: #aaa; text-decoration: none; font-size: 14px; padding: 5px 10px; border-radius: 15px; transition: background 0.3s; }
        .back-link:hover { background: rgba(255,255,255,0.1); color: white; }

        .main-container { display: flex; flex: 1; flex-direction: column; overflow: hidden; position: relative; }
        @media (min-width: 800px) { .main-container { flex-direction: row; } }

        /* === 2. æ’­æ”¾å™¨åŒºåŸŸ === */
        .player-section { flex-shrink: 0; width: 100%; background: #000; position: relative; display: flex; flex-direction: column; }
        @media (min-width: 800px) { .player-section { flex: 3; height: 100%; justify-content: center; } }

        .video-ratio-box { width: 100%; padding-top: 56.25%; position: relative; background: #000; }
        @media (min-width: 800px) { .video-ratio-box { padding-top: 0; height: 100%; } }
        
        .video-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; overflow: hidden; }
        
        video, iframe { width: 100%; height: 100%; border: none; outline: none; object-fit: contain; }

        /* === 3. æ‰‹åŠ¿åé¦ˆå±‚ === */
        /* è¦†ç›–åœ¨è§†é¢‘ä¸Šæ–¹çš„é€æ˜å±‚ï¼Œç”¨äºæ•è·æ‰‹åŠ¿ï¼ˆå¦‚æœè§†é¢‘æœ¬èº«æ‹¦æˆªäº†äº‹ä»¶ï¼‰å’Œæ˜¾ç¤ºåé¦ˆ */
        #gestureFeedback {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.6); backdrop-filter: blur(5px);
            padding: 15px 25px; border-radius: 10px;
            color: white; font-size: 16px; font-weight: bold;
            display: none; pointer-events: none; z-index: 20;
            text-align: center; border: 1px solid rgba(255,255,255,0.1);
        }
        #gestureFeedback .icon { font-size: 24px; display: block; margin-bottom: 5px; }

        /* === 4. å¿«æ·æ§åˆ¶æ¡ (ä¸Šä¸€é›†/ä¸‹ä¸€é›†) === */
        .control-bar {
            height: 40px; background: #111; display: flex; align-items: center; justify-content: space-between; padding: 0 15px;
            border-bottom: 1px solid #222;
        }
        .control-btn {
            background: #222; color: #ccc; border: none; padding: 5px 15px; border-radius: 4px; 
            font-size: 13px; cursor: pointer; text-decoration: none; display: flex; align-items: center;
        }
        .control-btn:hover { background: #333; color: white; }
        .control-btn.disabled { opacity: 0.3; pointer-events: none; }
        .ep-info-text { font-size: 12px; color: #666; }

        /* === 5. ä¾§è¾¹æ  (ç»ç’ƒæ‹Ÿæ€) === */
        .sidebar { 
            flex: 1; 
            background: #111; /* é™çº§èƒŒæ™¯ */
            display: flex; flex-direction: column; overflow: hidden; 
        }
        /* ç”µè„‘ç«¯å¯ç”¨ä¾§è¾¹æ æ¯›ç»ç’ƒ */
        @media (min-width: 800px) { 
            .sidebar { 
                border-left: 1px solid rgba(255,255,255,0.1); max-width: 350px; 
                background: rgba(20, 20, 20, 0.95);
            } 
        }

        .info-box { padding: 20px; border-bottom: 1px solid #222; }
        .title { font-size: 18px; color: white; margin-bottom: 10px; font-weight: bold; text-shadow: 0 2px 4px rgba(0,0,0,0.5); }
        .desc { font-size: 13px; color: #888; line-height: 1.5; max-height: 60px; overflow-y: auto; }
        
        .episodes-box { flex: 1; padding: 15px; overflow-y: auto; }
        .ep-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(60px, 1fr)); gap: 10px; }
        
        .ep-btn { 
            display: flex; align-items: center; justify-content: center; height: 36px;
            background: rgba(255,255,255,0.05); color: #bbb; text-decoration: none; 
            border-radius: 6px; font-size: 13px; transition: all 0.2s;
            border: 1px solid transparent;
        }
        .ep-btn:hover { background: rgba(255,255,255,0.1); color: white; }
        .ep-btn.active { 
            background: linear-gradient(135deg, #ff3b30, #ff9f0a); 
            color: white; font-weight: bold; border: none;
            box-shadow: 0 4px 10px rgba(255, 59, 48, 0.3);
        }
        
        /* æ¢å¤è¿›åº¦æç¤º */
        .toast { position: absolute; top: 10%; left: 50%; transform: translateX(-50%); background: rgba(16, 185, 129, 0.9); color: white; padding: 8px 20px; border-radius: 30px; font-size: 13px; display: none; z-index: 99; pointer-events: none; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
    </style>
</head>
<body>
    <div class="navbar">
        <a href="/" class="logo">MY FLIX PRO</a>
        <a href="/" class="back-link">â† è¿”å›é¦–é¡µ</a>
    </div>

    <div class="main-container">
        <div class="player-section">
            <div id="resumeToast" class="toast">ğŸš€ å·²ä¸ºæ‚¨æ¢å¤æ’­æ”¾è¿›åº¦</div>
            <div id="gestureFeedback"><span class="icon">ğŸ”Š</span><span class="text">50%</span></div>
            
            <div class="video-ratio-box">
                <div class="video-container" id="playerContainer">
                    </div>
            </div>
            
            <div class="control-bar">
                {% set prev_index = current_index - 1 %}
                {% if prev_index >= 0 %}
                <a href="/play?id={{ video.id }}&ep_index={{ prev_index }}&api={{ current_api }}" class="control-btn">â® ä¸Šä¸€é›†</a>
                {% else %}
                <span class="control-btn disabled">â® ä¸Šä¸€é›†</span>
                {% endif %}

                <span class="ep-info-text">æ­£åœ¨æ’­æ”¾: {{ current_ep.name }}</span>

                {% set next_index = current_index + 1 %}
                {% if next_index < video.episodes|length %}
                <a href="/play?id={{ video.id }}&ep_index={{ next_index }}&api={{ current_api }}" class="control-btn">ä¸‹ä¸€é›† â­</a>
                {% else %}
                <span class="control-btn disabled">ä¸‹ä¸€é›† â­</span>
                {% endif %}
            </div>
        </div>
        
        <div class="sidebar">
            <div class="info-box">
                <div class="title">{{ video.title }}</div>
                <div class="desc">{{ video.desc }}</div>
            </div>
            <div class="episodes-box">
                <div style="margin-bottom:12px;color:#888;font-size:12px;display:flex;justify-content:space-between;">
                    <span>é€‰é›†åˆ—è¡¨</span>
                    <span>å…± {{ video.episodes|length }} é›†</span>
                </div>
                <div class="ep-grid">
                    {% for ep in video.episodes %}
                    <a href="/play?id={{ video.id }}&ep_index={{ ep.index }}&api={{ current_api }}" 
                       class="ep-btn {% if ep.index == current_index %}active{% endif %}">
                        {{ ep.name }}
                    </a>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
    
    <script>
        var container = document.getElementById('playerContainer');
        var videoSrc = "{{ current_ep.url }}"; 
        var vodId = "{{ video.id }}";
        var epIndex = "{{ current_index }}";
        var currentApi = "{{ current_api }}";
        var storageKey = "progress_" + vodId + "_" + epIndex;
        var videoElement = null; // å…¨å±€å¼•ç”¨

        function initPlayer() {
            container.innerHTML = '';
            // åˆ¤æ–­æ˜¯å¦æ˜¯iframe (æ— æ³•æ·»åŠ æ‰‹åŠ¿)
            if (videoSrc.indexOf('.m3u8') === -1 && videoSrc.indexOf('.mp4') === -1) {
                var iframe = document.createElement('iframe');
                iframe.src = videoSrc; iframe.allow = "autoplay; fullscreen"; iframe.frameBorder = "0";
                container.appendChild(iframe); 
                saveHistoryToLocal();
                return; // iframe ä¸æ”¯æŒæ‰‹åŠ¿
            }

            // åˆ›å»º Video æ ‡ç­¾
            var video = document.createElement('video');
            video.id = 'videoPlayer'; 
            video.controls = true; 
            video.autoplay = true;
            // iOS å¿…é¡»å±æ€§ï¼Œé˜²æ­¢å¼ºåˆ¶å…¨å±æ— æ³•æ“ä½œ
            video.setAttribute('playsinline', ''); 
            video.setAttribute('webkit-playsinline', '');
            
            container.appendChild(video);
            videoElement = video;

            if (videoSrc.indexOf('.m3u8') > -1) {
                setupHls(video);
            } else {
                video.src = videoSrc; 
                setupNative(video);
            }

            // åˆå§‹åŒ–æ‰‹åŠ¿
            initGestures(container, video);
        }

        function setupHls(video) {
            if (Hls.isSupported()) {
                var hls = new Hls(); hls.loadSource(videoSrc); hls.attachMedia(video);
                hls.on(Hls.Events.MANIFEST_PARSED, function() { loadProgress(video); });
            } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
                video.src = videoSrc; video.addEventListener('loadedmetadata', function() { loadProgress(video); });
            }
            bindEvents(video);
        }

        function setupNative(video) {
            video.addEventListener('loadedmetadata', function() { loadProgress(video); });
            bindEvents(video);
        }

        function bindEvents(video) {
            video.addEventListener('timeupdate', function() { if (video.currentTime > 0) localStorage.setItem(storageKey, video.currentTime); });
            video.addEventListener('play', saveHistoryToLocal);
        }

        function loadProgress(video) {
            var lastTime = localStorage.getItem(storageKey);
            if (lastTime && parseFloat(lastTime) > 5) {
                video.currentTime = parseFloat(lastTime);
                var toast = document.getElementById('resumeToast');
                toast.style.display = 'block'; setTimeout(() => { toast.style.display = 'none'; }, 3000);
            }
            video.play().catch(e => {});
        }

        function saveHistoryToLocal() {
            var historyKey = "history_list";
            var history = JSON.parse(localStorage.getItem(historyKey) || "[]");
            history = history.filter(item => item.id !== vodId);
            history.unshift({
                id: vodId, title: "{{ video.title }}", ep_name: "{{ current_ep.name }}", ep_index: epIndex, pic: "{{ video.pic }}", api: currentApi, time: new Date().toLocaleDateString()
            });
            if (history.length > 20) history.pop();
            localStorage.setItem(historyKey, JSON.stringify(history));
        }

        // === æ‰‹åŠ¿æ§åˆ¶é€»è¾‘ ===
        function initGestures(touchArea, video) {
            let startX, startY;
            let initialVolume;
            let initialBrightness = 1.0; // CSS filter brightness default
            let isTouching = false;
            let touchType = ''; // 'volume' or 'brightness'

            // è·å–å½“å‰çš„ brightness
            // æ³¨æ„ï¼šå› ä¸ºæˆ‘ä»¬æ˜¯åŠ¨æ€è®¾ç½®filterï¼Œæ‰€ä»¥éœ€è¦ç”¨å˜é‡è®°å½•
            let currentBrightness = 1.0;

            touchArea.addEventListener('touchstart', (e) => {
                startX = e.touches[0].clientX;
                startY = e.touches[0].clientY;
                initialVolume = video.volume;
                isTouching = true;
                touchType = '';
            }, {passive: true});

            touchArea.addEventListener('touchmove', (e) => {
                if (!isTouching) return;
                
                let currentX = e.touches[0].clientX;
                let currentY = e.touches[0].clientY;
                let deltaY = startY - currentY; // å‘ä¸Šä¸ºæ­£
                let deltaX = currentX - startX;

                // ç®€å•çš„é˜²è¯¯è§¦ï¼šå¦‚æœæ°´å¹³ç§»åŠ¨å¤§äºå‚ç›´ç§»åŠ¨ï¼Œå¯èƒ½æ˜¯è°ƒæ•´è¿›åº¦ï¼ˆåŸç”Ÿæ§ä»¶ï¼‰ï¼Œå¿½ç•¥
                if (Math.abs(deltaX) > Math.abs(deltaY)) return;

                // ç¡®å®šæ˜¯è°ƒæ•´äº®åº¦è¿˜æ˜¯éŸ³é‡ (å±å¹•å·¦åŠè¾¹äº®åº¦ï¼Œå³åŠè¾¹éŸ³é‡)
                let screenWidth = window.innerWidth;
                if (!touchType) {
                    if (startX < screenWidth / 2) touchType = 'brightness';
                    else touchType = 'volume';
                }

                let percentChange = deltaY / 200; // çµæ•åº¦è°ƒèŠ‚

                if (touchType === 'volume') {
                    let newVol = initialVolume + percentChange;
                    if (newVol > 1) newVol = 1;
                    if (newVol < 0) newVol = 0;
                    video.volume = newVol;
                    showFeedback('ğŸ”Š', Math.round(newVol * 100) + '%');
                } else if (touchType === 'brightness') {
                    let newBright = currentBrightness + percentChange;
                    if (newBright > 2) newBright = 2; // æœ€å¤§2å€äº®åº¦
                    if (newBright < 0.1) newBright = 0.1; // æœ€ä½ä¸å…¨é»‘
                    currentBrightness = newBright; // ä»…åœ¨æ»‘åŠ¨ä¸­ä¸´æ—¶è®°å½•ï¼Œtouchendæ—¶ä¸ä¿å­˜ï¼Œå› ä¸ºä¸‹æ¬¡starté‡æ–°å–
                    
                    // åº”ç”¨æ»¤é•œåˆ°è§†é¢‘
                    video.style.filter = `brightness(${newBright})`;
                    showFeedback('â˜€', Math.round(newBright * 100) + '%');
                    
                    // æ³¨æ„ï¼štouchmoveé¢‘ç¹è§¦å‘ï¼ŒstartX/Yåº”è¯¥é‡ç½®å—ï¼Ÿ
                    // ä¸é‡ç½®ï¼ŒåŸºäºstartæ»‘åŠ¨è·ç¦»è®¡ç®—æ¯”è¾ƒå¹³æ»‘
                }
            }, {passive: false}); // passive: false å…è®¸ preventDefault (å¦‚æœéœ€è¦)

            touchArea.addEventListener('touchend', () => {
                isTouching = false;
                hideFeedback();
            });
        }

        var feedbackTimer;
        function showFeedback(icon, text) {
            var box = document.getElementById('gestureFeedback');
            box.innerHTML = `<span class="icon">${icon}</span><span class="text">${text}</span>`;
            box.style.display = 'block';
            clearTimeout(feedbackTimer);
        }
        function hideFeedback() {
            feedbackTimer = setTimeout(() => {
                document.getElementById('gestureFeedback').style.display = 'none';
            }, 500);
        }

        initPlayer();
    </script>
</body>
</html>