<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="referrer" content="no-referrer">
    <title>æ­£åœ¨æ’­æ”¾</title>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@1.4.0/dist/hls.min.js"></script>
    <style>
        body { margin: 0; background: #000; color: #e0e0e0; font-family: sans-serif; display: flex; flex-direction: column; height: 100vh; }
        
        /* å¯¼èˆªç²¾ç®€ */
        .navbar { height: 50px; padding: 0 15px; background: #1a1a1a; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; }
        .logo { font-weight: bold; color: #ff3b30; font-size: 16px; text-decoration: none; }
        .back-link { color: #888; text-decoration: none; font-size: 14px; padding: 10px; }

        /* å¸ƒå±€ï¼šæ‰‹æœºä¸Šæ˜¯ä¸Šä¸‹ç»“æ„ï¼Œç”µè„‘æ˜¯å·¦å³ç»“æ„ */
        .main-container { display: flex; flex: 1; flex-direction: column; overflow: hidden; }
        @media (min-width: 800px) { .main-container { flex-direction: row; } }

        /* æ’­æ”¾å™¨åŒºåŸŸ */
        .player-section { flex-shrink: 0; width: 100%; background: #000; position: relative; }
        /* ä¿æŒ16:9 */
        .video-ratio-box { width: 100%; padding-top: 56.25%; position: relative; }
        .video-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
        video, iframe { width: 100%; height: 100%; border: none; outline: none; }
        
        /* ç”µè„‘ç‰ˆè®©æ’­æ”¾å™¨æ’‘æ»¡å‰©ä½™ç©ºé—´ï¼Œä¸ç”¨å›ºå®šæ¯”ä¾‹ */
        @media (min-width: 800px) {
            .player-section { flex: 3; height: 100%; }
            .video-ratio-box { height: 100%; padding-top: 0; }
        }

        /* é€‰é›†åŒºåŸŸ */
        .sidebar { 
            flex: 1; background: #111; display: flex; flex-direction: column; overflow: hidden; 
            border-top: 1px solid #222; 
        }
        @media (min-width: 800px) { .sidebar { border-top: none; border-left: 1px solid #333; max-width: 350px; } }

        .info-box { padding: 15px; border-bottom: 1px solid #222; flex-shrink: 0; }
        .title { font-size: 16px; color: white; margin-bottom: 8px; font-weight: bold; }
        .desc { font-size: 12px; color: #666; line-height: 1.4; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        
        .episodes-box { flex: 1; padding: 15px; overflow-y: auto; }
        .ep-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(55px, 1fr)); gap: 8px; }
        .ep-btn { 
            display: block; text-align: center; padding: 10px 0; 
            background: #252525; color: #bbb; text-decoration: none; 
            border-radius: 4px; font-size: 13px; 
        }
        .ep-btn.active { background: #ff3b30; color: white; font-weight: bold; }
        
        .toast { position: absolute; top: 10%; left: 50%; transform: translateX(-50%); background: rgba(40, 167, 69, 0.9); color: white; padding: 8px 15px; border-radius: 20px; font-size: 12px; display: none; z-index: 99; pointer-events: none; }
    </style>
</head>
<body>
    <div class="navbar">
        <a href="/" class="logo">MY FLIX</a>
        <a href="/" class="back-link">è¿”å›</a>
    </div>

    <div class="main-container">
        <div class="player-section">
            <div id="resumeToast" class="toast">ğŸš€ å·²æ¢å¤è¿›åº¦</div>
            <div class="video-ratio-box">
                <div class="video-container" id="playerContainer">
                    <video id="videoPlayer" controls autoplay playsinline webkit-playsinline></video>
                </div>
            </div>
        </div>
        
        <div class="sidebar">
            <div class="info-box">
                <div class="title">{{ video.title }}</div>
                <div class="desc">{{ video.desc }}</div>
            </div>
            <div class="episodes-box">
                <div style="margin-bottom:10px;color:#888;font-size:12px">é€‰é›† ({{ current_ep.name }})</div>
                <div class="ep-grid">
                    {% for ep in video.episodes %}
                    <a href="/play?id={{ video.id }}&ep_index={{ ep.index }}&api={{ current_api }}" 
                       class="ep-btn {% if ep.index == current_index %}active{% endif %}">
                        {{ ep.name }}
                    </a>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // ... è¯·ä¿ç•™ä½ ä¹‹å‰é‚£ä¸ªå®Œç¾çš„ JS é€»è¾‘ ...
        // ... å”¯ä¸€éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œvideoæ ‡ç­¾æˆ‘åŠ äº† playsinline å±æ€§ï¼Œé˜²æ­¢iOSè‡ªåŠ¨å…¨å±é®æŒ¡ ...
        var container = document.getElementById('playerContainer');
        var videoSrc = "{{ current_ep.url }}"; 
        var vodId = "{{ video.id }}";
        var epIndex = "{{ current_index }}";
        var currentApi = "{{ current_api }}";
        var storageKey = "progress_" + vodId + "_" + epIndex;

        function initPlayer() {
            container.innerHTML = '';
            if (videoSrc.indexOf('.m3u8') > -1) {
                var video = document.createElement('video');
                video.id = 'videoPlayer'; video.controls = true; video.autoplay = true;
                video.setAttribute('playsinline', ''); video.setAttribute('webkit-playsinline', '');
                container.appendChild(video); setupHls(video);
            } else if (videoSrc.indexOf('.mp4') > -1) {
                var video = document.createElement('video');
                video.id = 'videoPlayer'; video.controls = true; video.autoplay = true;
                video.setAttribute('playsinline', '');
                video.src = videoSrc; container.appendChild(video); setupNative(video);
            } else {
                var iframe = document.createElement('iframe');
                iframe.src = videoSrc; iframe.allow = "autoplay; fullscreen"; iframe.frameBorder = "0";
                container.appendChild(iframe); saveHistoryToLocal();
            }
        }
        function setupHls(video) {
            if (Hls.isSupported()) {
                var hls = new Hls(); hls.loadSource(videoSrc); hls.attachMedia(video);
                hls.on(Hls.Events.MANIFEST_PARSED, function() { loadProgress(video); });
            } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
                video.src = videoSrc; video.addEventListener('loadedmetadata', function() { loadProgress(video); });
            }
            video.addEventListener('timeupdate', function() { if (video.currentTime > 0) localStorage.setItem(storageKey, video.currentTime); });
            video.addEventListener('play', saveHistoryToLocal);
        }
        function setupNative(video) {
            video.addEventListener('loadedmetadata', function() { loadProgress(video); });
            video.addEventListener('timeupdate', function() { if (video.currentTime > 0) localStorage.setItem(storageKey, video.currentTime); });
            video.addEventListener('play', saveHistoryToLocal);
        }
        function loadProgress(video) {
            var lastTime = localStorage.getItem(storageKey);
            if (lastTime && parseFloat(lastTime) > 5) {
                video.currentTime = parseFloat(lastTime);
                var toast = document.getElementById('resumeToast');
                toast.style.display = 'block'; setTimeout(() => { toast.style.display = 'none'; }, 3000);
            }
            video.play().catch(e => {});
        }
        function saveHistoryToLocal() {
            var historyKey = "history_list";
            var history = JSON.parse(localStorage.getItem(historyKey) || "[]");
            history = history.filter(item => item.id !== vodId);
            history.unshift({
                id: vodId, title: "{{ video.title }}", ep_name: "{{ current_ep.name }}", ep_index: epIndex, pic: "{{ video.pic }}", api: currentApi, time: new Date().toLocaleDateString()
            });
            if (history.length > 15) history.pop();
            localStorage.setItem(historyKey, JSON.stringify(history));
        }
        initPlayer();
    </script>
</body>
</html>